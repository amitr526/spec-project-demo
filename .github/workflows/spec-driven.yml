name: sdd

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      project-name:
        description: 'Project name to initialize'
        required: true
        default: 'my-project'
      feature-description:
        description: 'Feature description for /speckit.specify'
        required: false
        default: ''
      plan-prompt:
        description: 'Optional prompt or summary to pass to /speckit.plan'
        required: false
        default: ''
      tasks-options:
        description: 'Optional options for /speckit.tasks'
        required: false
        default: ''
      generate-tasks:
        description: 'Whether to run /speckit.tasks (true/false)'
        required: false
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Export workflow inputs to env
        run: |
          echo "PROJECT_NAME=${{ github.event.inputs['project-name'] }}" >> $GITHUB_ENV
          echo "FEATURE_DESC=${{ github.event.inputs['feature-description'] }}" >> $GITHUB_ENV
          echo "PLAN_PROMPT=${{ github.event.inputs['plan-prompt'] }}" >> $GITHUB_ENV
          echo "TASKS_OPTS=${{ github.event.inputs['tasks-options'] }}" >> $GITHUB_ENV
          echo "GENERATE_TASKS=${{ github.event.inputs['generate-tasks'] }}" >> $GITHUB_ENV

      - name: Set up Python (latest 3.x)
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install --upgrade pip
            pip install uwsgi uv
          fi

      - name: Install spec-kit
        run: |
          uv tool install specify-cli --force --from git+https://github.com/github/spec-kit.git

      - name: Run uvx init
        run: |
          specify init "$PROJECT_NAME"

      - name: Run speckit.specify
        run: |
          specify specify "$FEATURE_DESC"

      - name: Run speckit.plan
        run: |
          specify plan "$PLAN_PROMPT"

      - name: Run speckit.tasks
        if: ${{ github.event.inputs['generate-tasks'] == 'true' }}
        run: |
          specify tasks "$TASKS_OPTS"
